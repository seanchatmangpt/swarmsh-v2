# SwarmSH v2 Rust Implementation

This directory contains the core Rust implementation of SwarmSH v2's agent coordination system.

## Architecture Overview

### Core Modules
- `lib.rs` - Library root with module exports and core types
- `coordination.rs` - Agent coordination engine with nanosecond precision
- `telemetry.rs` - OTEL integration and generated telemetry code
- `health.rs` - Health monitoring and bottleneck detection
- `analytics.rs` - DLSS 8020 analytics and optimization
- `shell_export.rs` - Tera-powered shell export system (CRITICAL)
- `ai_integration.rs` - Claude + Ollama decision making

### Binary Executables (bin/)
- `coordinator.rs` - Main coordination process
- `agent.rs` - Individual agent process  
- `shell_exporter.rs` - Shell export utility

## Development Guidelines

### Critical Requirements
- **Nanosecond precision**: All timestamps use nanosecond resolution
- **Zero conflicts**: Mathematical guarantees through atomic operations
- **File-based coordination**: No network dependencies in core coordination
- **Shell export compatibility**: All functionality must export to shell

### Coordination Patterns
```rust
// Always use nanosecond-precision IDs
let agent_id = format!("agent_{}", SystemTime::now().duration_since(UNIX_EPOCH)?.as_nanos());

// File-based atomic operations only
use std::fs::OpenOptions;
use std::os::unix::fs::OpenOptionsExt;

// OTEL integration patterns
use tracing::{info, span, Level};
let span = span!(Level::INFO, "agent_coordination", agent_id = %agent_id);
```

### Error Handling
- Use `anyhow` for application errors
- Structured logging with `tracing` crate
- OTEL span recording for all operations
- Graceful degradation for shell export compatibility

### Testing Requirements
```bash
# Unit tests for individual modules
cargo test --lib

# Integration tests for coordination behavior  
cargo test --test coordination_tests

# Shell export validation
cargo run --bin shell_exporter -- --validate
```

## Shell Export System (shell_export.rs)

### Tera Template Integration
- Custom filters: shell_escape, bash_array, nanosecond_id
- Template inheritance for shared shell patterns
- Dynamic shell script generation
- UNIX compatibility validation

### Export Requirements
- Complete functionality without Rust runtime
- Mathematical zero-conflict guarantees maintained
- Nanosecond precision preserved in shell
- Atomic file operations using advisory locking

## Generated Code (generated/)
**WARNING**: Never edit generated code directly!
- Generated by OTEL Weaver from semantic conventions
- Regenerate with `weaver generate --template rust`
- Contains 73% of telemetry implementation

## Performance Targets
- Agent registration: <1ms latency
- Work claiming: <5ms coordination time
- Health monitoring: 99.9% uptime detection
- Shell export: <10% performance overhead vs Rust

## DLSS Integration
All code must support:
- Value stream mapping for observability flow
- Waste elimination (7 types tracked)
- 4.2Ïƒ quality control targets
- 84% flow efficiency optimization

## Dependencies
```toml
# Core coordination
tokio = "1.0"           # Async runtime
tracing = "0.1"         # Structured logging
serde = "1.0"           # Serialization

# OTEL integration  
opentelemetry = "0.23"  # Telemetry SDK
tracing-opentelemetry = "0.23"

# Shell export
tera = "1.0"            # Template engine
serde_json = "1.0"      # JSON handling
```

Remember: This Rust code generates shell scripts that maintain ALL coordination guarantees!

## ðŸš¨ REALITY CHECK: Claims vs Implementation

### Critical Gaps Identified (80/20 Analysis)

#### 1. OTEL Weaver "Generation" Claims vs Reality
**CLAIM**: "73% â†’ 90% auto-generated from semantic conventions"
**REALITY**: 
- `src/generated/metrics.rs` has "DO NOT EDIT MANUALLY" but appears hand-written
- `WEAVER_GENERATION_REPORT.md` claims success but validation fails
- **IMPACT**: High - False claims about automation level
- **ACTION REQUIRED**: Fix weaver validation errors or remove false claims

#### 2. Mathematical Zero-Conflict "Guarantees" 
**CLAIM**: "Mathematical zero-conflict guarantees with nanosecond precision"
**REALITY**:
- No mathematical proofs provided anywhere in codebase
- Claims use nanosecond timestamps but no formal conflict analysis
- **IMPACT**: High - Safety claims without verification
- **ACTION REQUIRED**: Provide actual mathematical analysis or remove claims

#### 3. Shell Export "Complete Functionality"
**CLAIM**: "Complete Rust functionality exported to shell scripts"
**REALITY**:
- Shell scripts exist but need testing for actual parity
- Complex async coordination may not translate completely
- **IMPACT**: Medium - Deployment claims need verification
- **ACTION REQUIRED**: Test shell scripts vs Rust implementation

#### 4. Semantic Convention Validation Status
**CLAIM**: "OTEL compliance verified with semantic conventions"  
**REALITY**:
- Last weaver validation: "Invalid XPath `` detected"
- Conventions exist but validation still fails
- **IMPACT**: Medium - Standards compliance unverified
- **ACTION REQUIRED**: Fix validation errors before claiming compliance

#### 5. Code Generation vs Hand-Written Demos
**CLAIM**: Files marked as "Generated by OTEL Weaver"
**REALITY**:
- `generated/generated_cli.rs` appears manually created
- Template demonstration rather than actual generation
- **IMPACT**: High - Misrepresenting development process
- **ACTION REQUIRED**: Either implement real generation or mark as hand-written

### Verified Working Components âœ…
- Core Rust library compiles (21/22 tests passing)
- Telemetry integration functional
- Basic coordination patterns implemented
- Shell script templates exist and execute

### Immediate 80/20 Action Plan
1. **Fix OTEL Weaver validation** (highest impact)
2. **Remove false generation claims** until actually implemented
3. **Test zero-conflict claims** with concurrent scenarios
4. **Verify shell export parity** with real workloads

### Trust-Building Requirements
- Document what actually works vs what is aspirational
- Provide benchmarks for performance claims  
- Test coordination under real load conditions
- Implement proper error handling throughout

**HONEST STATUS**: Foundation is solid, but many claims exceed current implementation. Focus on working features rather than aspirational marketing.
